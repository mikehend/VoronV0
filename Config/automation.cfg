# Automation Configuration for Voron V0
# Automated LED control, idle timeouts, and power-saving features
# Ported from Voron 2.4 automation system

##############################################
# Idle Timeout Configuration
##############################################

# Variables to track activity state
[gcode_macro _AUTOMATION_VARS]
variable_lights_on: 1           # 1 = lights on, 0 = lights off
variable_idle_timeout: 3600     # Seconds until lights turn off (3600 = 1 hour)
variable_idle_start_time: 0     # When printer went idle
variable_check_count: 0         # Number of checks since idle started
gcode:
    # This macro just holds variables

##############################################
# Delayed G-code for Idle Monitoring
##############################################

[delayed_gcode CHECK_IDLE_TIMEOUT]
initial_duration: 60            # Check every 60 seconds
gcode:
    {% set vars = printer["gcode_macro _AUTOMATION_VARS"] %}
    {% set idle_state = printer.idle_timeout.state %}
    {% set print_state = printer.print_stats.state %}

    # If printer is printing, reset counter and keep checking
    {% if print_state == "printing" %}
        SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=check_count VALUE=0
        UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60
    # If printer is idle and lights are on, increment counter and check timeout
    {% elif idle_state == "Idle" and vars.lights_on == 1 %}
        {% set new_count = vars.check_count + 1 %}
        SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=check_count VALUE={new_count}
        {% set idle_seconds = new_count * 60 %}
        {% if idle_seconds >= vars.idle_timeout %}
            RESPOND MSG="Idle timeout reached ({idle_seconds}s) - turning off lights"
            _LIGHTS_IDLE_OFF
        {% else %}
            UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60
        {% endif %}
    {% else %}
        # Not idle or lights already off - reset counter
        SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=check_count VALUE=0
        UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60
    {% endif %}

##############################################
# Light Control Macros
##############################################

[gcode_macro _LIGHTS_IDLE_OFF]
description: Turn off lights after idle timeout
gcode:
    RESPOND MSG="Entering power-save mode - lights off"
    CABINET_OFF
    TOOLHEAD_OFF
    SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=lights_on VALUE=0

[gcode_macro _LIGHTS_ACTIVITY]
description: Reset idle timer when activity detected
gcode:
    {% set vars = printer["gcode_macro _AUTOMATION_VARS"] %}
    # Reset idle counter
    SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=check_count VALUE=0
    # If lights were off, turn them back on
    {% if vars.lights_on == 0 %}
        RESPOND MSG="Activity detected - turning lights on"
        CABINET_WHITE
        TOOLHEAD_READY
        SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=lights_on VALUE=1
    {% endif %}
    # Reset the idle timeout check
    UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60

##############################################
# User-Callable Macros
##############################################

[gcode_macro LIGHTS_AUTO]
description: Enable automatic light control (turns off after idle)
gcode:
    SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=lights_on VALUE=1
    UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60
    RESPOND MSG="Automatic light control ENABLED (timeout: {printer['gcode_macro _AUTOMATION_VARS'].idle_timeout}s)"

[gcode_macro LIGHTS_MANUAL]
description: Disable automatic light control (stays on)
gcode:
    UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=0
    RESPOND MSG="Automatic light control DISABLED - lights will stay on"

[gcode_macro SET_LIGHT_TIMEOUT]
description: Set light auto-off timeout in seconds (e.g., SET_LIGHT_TIMEOUT SECONDS=3600)
gcode:
    {% set timeout = params.SECONDS|default(3600)|int %}
    SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=idle_timeout VALUE={timeout}
    RESPOND MSG="Light timeout set to {timeout} seconds ({timeout/60} minutes)"

##############################################
# Print Start/End Automation
##############################################

[gcode_macro _PRINT_START_AUTOMATION]
description: Called at print start - turns on lights, disables auto-off
gcode:
    RESPOND MSG="Print starting - activating print lighting"
    # Keep lights on during print
    SET_GCODE_VARIABLE MACRO=_AUTOMATION_VARS VARIABLE=lights_on VALUE=1
    # Disable idle timeout during printing
    UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=0

[gcode_macro _PRINT_END_AUTOMATION]
description: Called at print end - sets completion status, re-enables auto-off
gcode:
    RESPOND MSG="Print complete - entering idle mode"
    # Show print complete status
    TOOLHEAD_READY
    CABINET_GREEN
    # Wait 30 seconds, then switch to normal idle lighting
    UPDATE_DELAYED_GCODE ID=_PRINT_COMPLETE_COOLDOWN DURATION=30

[delayed_gcode _PRINT_COMPLETE_COOLDOWN]
gcode:
    # After 30 seconds, switch to normal ready state
    TOOLHEAD_READY
    CABINET_WHITE
    # Re-enable idle monitoring
    UPDATE_DELAYED_GCODE ID=CHECK_IDLE_TIMEOUT DURATION=60

##############################################
# Startup Automation
##############################################

[delayed_gcode _STARTUP_AUTOMATION]
initial_duration: 2             # Run 2 seconds after Klipper starts
gcode:
    RESPOND MSG="Voron V0 automation system initialized"
    RESPOND MSG="Idle timeout: {printer['gcode_macro _AUTOMATION_VARS'].idle_timeout}s"
    RESPOND MSG="Use LIGHTS_AUTO to enable auto-off, LIGHTS_MANUAL to disable"
    # Start with lights on and auto-off enabled
    CABINET_WHITE
    TOOLHEAD_READY
    LIGHTS_AUTO
